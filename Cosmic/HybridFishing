--[=====[
[[SND Metadata]]
author: SubaruYashiro || Updated by: Minnu (https://ko-fi.com/minnuverse)
version: 2.0.0
description: HybridFishing - Script for Farming Cosmic Fishing Points
plugin_dependencies:
- Artisan
- Autohook
- Lifestream
- vnavmesh
- ChatCoordinates
- ICE

[[End Metadata]]
--]=====]

--[[
********************************************************************************
*                               HybridFishing                                  *
*                               Version 2.0.0                                  *
********************************************************************************

Created by: SubaruYashiro
Updated by: Minnu

HybridFishing is a handy little script that helps you rack up Cosmic Fishing
Points without all the grind. Just run it, and it takes care of the fishing
and turn-ins for you, making point farming smoother and way less of a hassle.

    -> 2.0.0    Updated for Patch 7.3
                Renamed Mission Names

********************************************************************************
*                               Required Plugins                               *
********************************************************************************
-> Autohook
-> Artisan
-> vnavmesh
-> Lifestream
-> ChatCoordinates
-> Ice's Cosmic Exploration

********************************************************************************
*            Code: Don't touch this unless you know what you're doing          *
********************************************************************************
--]]

import("System.Numerics")

MissionName   = "EX: Refined Moon Gel"
Coords        = "/coord 15.8 19.4"
Preset        = "AH4_H4sIAAAAAAAACu1Y227bOBD9FYPP5kKiqJvfXG+aBnDaIs5iFyj2YSSNbCIy5VJUt9nA/15Ql1hSbMdps0WzyJtNcc6cGZ2ZIXVHpqXOZ1DoYpYuyeSOnEmIMpxmGZloVeKYXGEMhZ5KsQYtcjkDGeP9w+tSyVmeZRjrD2nars5W5fqAgXE1FxKNq4ulzBVe5nm8IpMUsgLHjfuk3X6RkAkLwjH5qESuhL4lE3tMLoqzr3FWJpjsls3+bY3fIN6R6gerXBkcLxiT8831SmGxyrOETGzL6iEfh64wQr9nYT1KxuSiZcBtiw8oOAMKrVWd046h3d3GHnebq0RAtnujvZTazPN6SeWN2VtRrM5useg4dgeMXbfH2GuTDje4WIlUvwFR8TYLRbuw0BDfFGTiNmn0goe4XdSwQf0IWqCMscPHG9p5/Qyy1lSJf3EGupZC63VoHQR9a6exvl5BJuCmeAtfcmUAegttOM64v36Fcf4FFZnYJkn7tOwFRgIdh23+3ojlOayrQKdymaEqWifmZRul+BYfsmc9qGC7HZOzr1pBU8sm89f54h/YXEhdClON5yBkmw9qj8m8VHiJRQFLJBNCxuR9RYK8zyWScY1wu0EyMYnZgzfPC/3deB8VFrifIaHkwPPaY/V8x2exwVgryGalUij1M0U5QH22WPeyfRDxXu/VrlogC51vTL0KuVxo3FSdcce9EdFUPQ/lLlzF4Q8pPpdocInrpDFnLlD0g5TyxI5oBFZK0bNCFqKFUZKQ7ZjMRaE/pMZHQSafanmaAO4JhuFhhtMsG9WmQ5rvc7WG7F2e3xigtmP8iVD9N+sF6vta7M2Z5qEJsK3SZqmG57ZvOlGLudAql50pucf8Er6a1WuxrtvAb9YDSMvpQM5xiTIBdfu9XCtPg05zKWSXBDMkzBzat9es9/d7hzj/npdR9lhie4bMC+/tdsl7quUpORrk/UEINd61EpsnRuC7zLm3fGIMPdtTovhZL7RlZlrINNWoZlAuV3ou1mZ2s/pBv7dYjDent1LV5wPzozMI90w7x3fD4YHHDMaDZxdzymr7fFvQV/i5FAqThQZdmiOEOcb9nCr/QdTnLfSXVI0vtPROrA97X30cL45D1XD0ArHtTVlIMQo4ONR1LE556Nk0tPyQWg73MXKZ60JMtn+3Y7a5BH3qnP+bSB+M3aeeC04auKeV1sml8rj0T9D4aWJ+VLUnyfNUHf5igvuh9vv6zl/kO+80mSSOk8SJPOo5nk85JDENk9imkFoOj1zPZk7UaTJ1G/l0R7r9hLshO9JSLvNcZkKPZqA2vdZiH8vFRYJSixgykwDjqd4wXeel7G2r/A/vyU7/m0VgPJUqhRgXmZmyez+ScDccfqNgfRzb3Y7JL/O1aXf3++7ObozNysxktUpo9w7Y3PzMz3p5t22fVDuywjgAj/tmbDFOeZD6NEzdgIIfxin3wwCsgGzHD3RkH7kQzksJanQFAtbQvxS+Cul/K6TAAj+xU5cmbupTnoBHIzeMqZs4VgzcDoHhPiExdjiAd/lmI+RyNC/lMjVmj2ipfbVHL0/Vg6tObK0c/lv1HZLbQDGvcpOH5Fbdc7sT0U0xQQyo51iM8tRNaBD5Pg05Wo4DoRVbvJqINXTD8uyvyegKUyExGZmBNzrHrP/RLI3TyMMQqBWFDuUOYxQgdSkLYggjJ2KO75PtN9O4jRmgGQAA"
ItemId        = 45922
ItemAmount    = 2
SuccessCount  = 0
ClassId       = Player.Job.Id

function Init()
    if ClassId ~= 18 then
        yield("/echo [HybridFishing] Wrong class.. Aborting.")
        return false
    end

    if not Player.Gearset or not Player.Gearset.Name or Player.Gearset.Name == "" then
        yield("/echo [HybridFishing] Fisher gearset not detected.. Aborting.")
        return false
    end
    Class = Player.Gearset.Name

    return true
end

function WaitForPlayer()
    Dalamud.Log("[HybridFishing] Waiting For Player...")
    while not Player.Available or Player.IsBusy do
        yield("/wait 0.1")
    end
    yield("/wait 1")
end

function WaitForZoneChange()
    repeat
        yield("/wait 0.1")
    until Svc.Condition[45]
    yield("/wait 1")
    repeat
        yield("/wait 0.1")
    until not Svc.Condition[45]
    yield("/wait 1")
end

function WaitForVnavMesh()
    repeat
        yield("/wait 0.1")
    until not IPC.vnavmesh.PathfindInProgress() and not IPC.vnavmesh.IsRunning()
    yield("/wait 0.1")
end

function MoveToSpot()
    IPC.Lifestream.ExecuteCommand("Cosmic")
    repeat
        yield("/wait 0.1")
    until not IPC.Lifestream.IsBusy()
    yield("/wait 0.1")
    WaitForZoneChange()
    Dalamud.Log(string.format("[HybridFishing] Heading to %s", MissionName))
    yield(Coords)
    yield("/wait 0.1")
    IPC.vnavmesh.PathfindAndMoveTo(Vector3(-89.203, -3.337, -27.259), false)
    WaitForVnavMesh()
    yield("/ice start")
end

function WaitForFishingItem(maxWaitSeconds)
    local waitElapsed = 0
    local retryCount  = 0
    local maxRetries  = 3

    IPC.AutoHook.CreateAndSelectAnonymousPreset(Preset)
    IPC.AutoHook.SetPluginState(true)
    yield("/wait 1")

    while not Svc.Condition[43] and retryCount < maxRetries do
        retryCount = retryCount + 1
        Dalamud.Log("[HybridFishing] Attempting to start fishing (retry " .. retryCount .. ")")
        yield("/ahstart")
        yield("/wait 5")
    end

    if not Svc.Condition[43] then
        yield("/echo [HybridFishing] Failed to start fishing after retries.")
        Dalamud.Log("[HybridFishing] Fishing did not start after retries.")
        return false
    end

    Dalamud.Log("[HybridFishing] Waiting to obtain item ID " .. ItemId .. " x" .. ItemAmount)
    while Inventory.GetItemCount(ItemId) < ItemAmount and waitElapsed < maxWaitSeconds do
        yield("/wait 1")
        waitElapsed = waitElapsed + 1
    end

    if Inventory.GetItemCount(ItemId) < ItemAmount then
        IPC.AutoHook.SetPluginState(false)
        yield("/wait 1")
        while Svc.Condition[6] do
            yield("/ac Quit")
            yield("/wait 0.1")
        end
        yield("/echo [HybridFishing] Timeout waiting for item ID " .. ItemId)
        Dalamud.Log("[HybridFishing] Timeout acquiring item ID " .. ItemId)
        return false
    end

    if Svc.Condition[43] then
        Dalamud.Log("[HybridFishing] Still in fishing mode, waiting to exit.")
        yield("/wait 1")
        while Svc.Condition[43] do
            yield("/wait 0.1")
        end
    end

    IPC.AutoHook.SetPluginState(false)
    Dalamud.Log("[HybridFishing] Successfully acquired required items.")
    return true
end

function StartCrafting()
    if not Addons.GetAddon("WKSRecipeNotebook").Ready then
        if not Addons.GetAddon("WKSMissionInfomation").Ready then
            yield("/callback WKSHud true 11")
            yield("/wait 0.2")
        end

        if not Addons.GetAddon("WKSRecipeNotebook").Ready then
            yield("/callback WKSMissionInfomation true 14 1")
        end
    end

    yield("/wait 0.5")
    Dalamud.Log("[HybridFishing] Crafting..")
    IPC.Artisan.SetEnduranceStatus(true)
    yield("/wait 10")

    while IPC.Artisan.GetEnduranceStatus() == true do
        yield("/wait 0.5")
    end

    Dalamud.Log("[HybridFishing] Crafting completed successfully.")
    yield("/wait 1")
end

function SubmitReport()
    Dalamud.Log("[HybridFishing] Reporting the Mission..")
    if not Addons.GetAddon("WKSMissionInfomation").Ready then
        yield("/callback WKSHud true 11")
        yield("/wait 0.2")
    end

    if Addons.GetAddon("WKSRecipeNotebook").Ready then
        yield("/callback WKSMissionInfomation true 14 1")
    end

    while Svc.Condition[5] do
        yield("/wait 0.1")
    end

    yield("/wait 1")
    Dalamud.Log("[HybridFishing] Changing Gearset to " .. Class)
    yield("/gs change " .. Class)
    yield("/wait 1")
    yield("/callback WKSMissionInfomation true 11 1")
    yield("/wait 1")
end

function RepairIfNeeded(RepairCount)
    if SuccessCount == 0 or SuccessCount % RepairCount ~= 0 then
        return
    end

    yield("/wait 2")
    Dalamud.Log("[HybridFishing] Attempting to repair gear...")

    while not Addons.GetAddon("Repair").Ready do
        yield("/generalaction repair")
        yield("/wait 0.5")
    end

    yield("/callback Repair true 0")
    yield("/wait 0.1")

    if Addons.GetAddon("SelectYesno").Ready then
        yield("/callback SelectYesno true 0")
        yield("/wait 0.1")
    end

    while Svc.Condition[39] do
        yield("/wait 1")
    end

    yield("/wait 1")
    yield("/callback Repair true -1")
    yield("/wait 2")
    Dalamud.Log("[HybridFishing] Repair complete.")
end

if Init() then
    Dalamud.Log("[HybridFishing] MissionName: " .. MissionName)
    Dalamud.Log("[HybridFishing] MissionCoords: " .. Coords)
    Dalamud.Log("[HybridFishing] MissionPreset: " .. Preset)
else
    return
end

while true do
    if SuccessCount == 0 then
        MoveToSpot()
        IPC.vnavmesh.PathfindAndMoveTo(Vector3(-264.005, 22.156, -94.770), false)
        WaitForVnavMesh()
    elseif SuccessCount == 5 then
        IPC.vnavmesh.PathfindAndMoveTo(Vector3(-259.450, 22.337, -75.942), false)
        WaitForVnavMesh()
    elseif SuccessCount == 10 then
        IPC.vnavmesh.PathfindAndMoveTo(Vector3(-297.165, 22.075, -91.238), false)
        WaitForVnavMesh()
    end


    local currentMissionName = ""
    while (currentMissionName ~= MissionName) do
        yield("/wait 0.5")
        if Addons.GetAddon("WKSMissionInfomation").Ready then
            currentMissionName = Addons.GetAddon("WKSMissionInfomation"):GetNode(1,3).Text
        end
    end

    yield("/wait 1")
    if not WaitForFishingItem(500) then
        yield("/echo [HybridFishing] Fishing failed. Proceeding to submit report only.")
        Dalamud.Log("[HybridFishing] Fishing step failed or timed out.")
        WaitForPlayer()
        SubmitReport()
        SuccessCount = 0
    elseif Inventory.GetItemCount(ItemId) >= ItemAmount then
        Dalamud.Log("[HybridFishing] Sufficient items available, starting crafting.")
        WaitForPlayer()
        StartCrafting()
        SubmitReport()
        SuccessCount = SuccessCount + 1
        yield("/echo [HybridFishing] SuccessCount: " .. SuccessCount)
        Dalamud.Log("[HybridFishing] SuccessCount: " .. SuccessCount)
    end

    WaitForPlayer()
    RepairIfNeeded(15)

    if SuccessCount == 15 then
        SuccessCount = 0
    end
end
